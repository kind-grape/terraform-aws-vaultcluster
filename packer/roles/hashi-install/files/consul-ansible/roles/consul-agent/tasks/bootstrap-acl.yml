# - name: Fetch master server token from parameter store
#   shell: "aws ssm get-parameter --output json --region {{ ansible_ec2_placement_region }} --with-decryption --name consul-{{ consul_join_tag_value }}-acl-master | jq -r '.Parameter | .Value'"
#   register: consul_acl_master_token_read
#
# - name: Set Master Token
#   set_fact: consul_acl_master_token="{{ consul_acl_master_token_read.stdout }}"

- name: Create agent, appliction ACL policies and tokens
  block:

  # - name: Add ACL configuration
  #   template:
  #     src: etc/consul.d/acl.hcl.j2
  #     dest: '{{consul_config_path}}/acl.hcl'
  #     owner: '{{consul_user}}'
  #     group: '{{consul_group}}'
  #     mode: 0660

  - name: Create Agent Token
    import_tasks: agent-token.yml

  - name: Create Vault Token
    import_tasks: vault-token.yml

  - name: Fetch client agent token from parameter store
    shell: "aws ssm get-parameter --output json --region {{ ansible_ec2_placement_region }} --with-decryption --name consul-{{ consul_join_tag_value }}-client | jq -r '.Parameter | .Value'"
    register: client_agent_token_cmd

  - name: Set Client Agent Token
    set_fact:
      client_agent_token: "{{ client_agent_token_cmd.stdout }}"

  - name: Replace ACL token placeholder in Consul config
    lineinfile:
      path: /etc/consul.d/acl.hcl
      regexp: "## AGENT_TOKEN_PLACEHOLDER ##"
      line: "    agent = \"{{ client_agent_token }}\""

  - name: Restart Consul
    service: name=consul state=restarted
