- name: Check to see if cluster is bootstrapped
  stat: path="{{ consul_config_path }}/bootstrapped"
  register: bootstrap_file
  ignore_errors: yes

- name: Get KV bootstrap
  shell: |
    . /etc/profile.d/99-consul-env.sh
    export CONSUL_HTTP_TOKEN=$(sudo cat /etc/consul.d/tokens/agent)
    consul kv get acl-bootstrap-complete
  register: consul_bootstrap
  until: consul_bootstrap.stdout == "1"
  retries: 120
  delay: 3
  ignore_errors: yes
  when: bootstrap_file.stat.exists == false

- name: Set Bootstrap Success
  copy:
    content: "true"
    dest: "{{ consul_config_path }}/bootstrapped"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: 0640
  when:
    - bootstrap_file.stat.exists == false
    - consul_bootstrap.stdout == "1"
